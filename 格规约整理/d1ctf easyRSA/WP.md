## easyRSA

This is a common modules attack but when the task is about end someone tell me that this challenge is same as the challenge in D^3CTF [Common](https://github.com/D-3CTF/D3CTF-2019-Challenges). Last year I didn't look at the crypto challenge in this task. So I want to make a sincere apology to the person, [Lurkrul](https://gist.github.com/LurkNoi) ,who made the challenge. Sorry about this.

And here is the solution:

In this a RSA task. We can find out that the e has been generated by this way:
$$
e_1d_1 = 1 + k_1\lambda(N)
$$

$$
e_2d_2 = 1 + k_2\lambda(N)
$$

And there are some limits:
$$
limit = \sqrt[3]{N}
$$

$$
limit < r < 0x1000000000001 * limit
$$

$$
d_i = nextPrime(r)
$$

$$
e_i \approx N
$$

We choose a random $e$ in $[e_1$ , $e_2]$ to encrypt flag,
$$
flag^{e} \equiv cipher \pmod n
$$
And give these parameters:
$$
N,e1,e2,cipher
$$
In this task, we can get some equation:
$$
e_id_i = 1 + k_i \lambda(N) = 1 + \frac {k_i}{g} \Phi(N) = 1 + \frac {k_i}{g} (N-s)
$$
And we rewrite it as:
$$
W_i: e_id_ig - k_iN = g - k_is
$$
This equation is the starting point for Wiener's attack.

Also we can get this easily:
$$
G_{i,j}: k_ie_jd_j - k_je_id_i = k_i - k_j
$$
This equation is the starting point for Guo's common modulus attack.

Then we assume:
$$
k_2W_1: k_2e_1d_1g - k_2k_1N = k_2(g-k_1s)
$$

$$
gG_{1,2} : k_1e_2d_2g - k_2e_1d_1g = g(k_1-k_2)
$$

$$
W_1W_2 : d_1d_2g^2e_1e_2 - d_1k_2ge_1N - d_2k_1ge_2N + k_1k_2N^2 = (g-k_1s)(g-k_2s)
$$

Along with the trivial equation:
$$
k1k2 = k2k1
$$
can be written as the vector-matrix equation:
$$
x_2B_2 = v_2
$$
where:
$$
x_2 = (k_1k_2,k_2d_1g,k_1d_2g,d_1d_2g^2)
$$

$$
B_2 = \begin{bmatrix}1 & -N & 0 & N^2 \\  & e_1 & - e_1 & -e_1N\\ & & e_2 & -e_2N \\ & & & e_1e_2\end{bmatrix}
$$

$$
v_2 = (k_1k_2,k_2(g-k_1s),g(k_1-k_2),(g-k_1s)(g-k_2s))
$$

The vector $v_2$ is an integer linear combination of the rows in $B_2$, and is therefore a vector in the lattice $L_2$generated by the rows of $B_2$.

And the size of $v_2$, coming from the dominant last component, is roughly 
$$
k_1k_2s^2 \approx N^{2\delta_2+1} = N^{2(\delta_2+1/2)}
$$

$$
\delta_2 = 0.357 - \epsilon \ , \ \epsilon \ is \ small
$$

Since the components of $v_2$ are not the same size,  we can consider the modified vector-matrix equation:
$$
x_2B_2D_2 = v_2D_2
$$
Where $D_2$ is the diagonal matrix:
$$
D_2 = \begin{bmatrix}N &  &  &  \\  &  N^{(1/2)} & & \\ & & N^{1+\delta_2} &  \\ & & & 1\end{bmatrix}
$$
Letting:
$$
v^{'}_2 = v_2D_2
$$
Thus:
$$
v^{'}_2 = (k_1k_2N,k2(g-k_1s)N^{(1/2)},g(k_1-k_2)N^{1+\delta_2},(g-k_1s)(g-k_2s))
$$
We can use LLL to get $v^{'}_2$ and solve:	
$$
x_2B_2D_2 = v^{'}_2
$$
to get $x_2$

Finally we can get $\Phi(N)$ by:
$$
\Phi(N) = \lfloor {e_1 \frac {x_2[2]}{x_2[1]}}\rfloor
$$
So we can decrypt the cipher to get flag !



If you want to know more details about this attack, take a look at this [paper](https://sci-hub.tw/https://link.springer.com/chapter/10.1007/3-540-46701-7_14).



Reference:

https://sci-hub.tw/https://link.springer.com/chapter/10.1007/3-540-46701-7_14

https://eprint.iacr.org/2009/037.pdf







